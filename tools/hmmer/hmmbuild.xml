<?xml version="1.0"?>
<tool id="hmmer.hmmbuild" name="hmmbuild" version="@WRAPPER_VERSION@.0">
  <description>Build a profile HMM from an input multiple alignment</description>
  <macros>
    <import>macros.xml</import>
  </macros>
  <expand macro="requirements"/>
  <expand macro="stdio"/>
  <command><![CDATA[
hmmbuild
$input_format_select

--cpu \${GALAXY_SLOTS:-2}
--$mcs.model_construction_strategy_select

#if $mcs.model_construction_strategy_select == "fast":
--symfrac $mcs.symfrac
#end if

$arsws.arsws_select

#if $arsws.arsws_select == "--wblosum":
--wid $arsws.wid
#end if

#if $aeews.aeews_select != "":
--$aeews.aeews_select
    #if $aeews.aeews_select == "eent":
        --eset $aeews.eset
        --ere $aeews.ere
        --eent $aeews.eent
    #elif $aeews.aeews_select == "eclust":
        --eset $aeews.eset
        --edi $aeews.edi
    #end if
#end if

$aps_select

#if $hssi.hssi_select == "singlemx":
    --popen $hssi.popen
    --pextend $hssi.pextend
#end if

--EmL $EmL
--EmN $EmN
--EvL $EvL
--EvN $EvN
--EfL $EfL
--EfN $EfN
--Eft $Eft

--seed $seed

$hmmout
$msafile
      ]]></command>
  <inputs>
      <param name="msafile" type="data" label="Input alignment" />

      <!-- Options for selecting alphabet rather than guessing it -->
      <param name="input_format_select" type="select" label="Format of input file">
          <option value="" selected="true">Guess Format</option>
          <option value="--amino">Protein</option>
          <option value="--dna">DNA</option>
          <option value="--rna">RNA</option>
      </param>
      <!-- Alternative model construction strategies -->
      <conditional name="mcs">
          <param name="model_construction_strategy_select" type="select" label="Model Construction Strategy">
              <option value="fast" selected="true">Assign columns with &gt;= symfrac residues as consensus</option>
              <option value="hand">Manual construction (requires reference annotation)</option>
          </param>
          <when value="fast">
              <param name="symfrac" value="0.5" type="float"
                  label="Sets sym fraction controlling --fast construction" />
          </when>
      </conditional>
      <!-- Alternative relative sequence weighting strategies -->
      <conditional name="arsws">
          <param name="arsws_select" type="select" label="Alternative relative sequence weighting strategies">
              <option value="--wpb" selected="true">Henikoff position-based weights (--wpb)</option>
              <option value="--wgsc">Gerstein/Sonnhammer/Chothia tree weights (--wgsc)</option>
              <option value="--wblosum">Henikoff simple filter weights (--wblosum)</option>
              <option value="--wnone">don't do any relative weighting; set all to 1 (--wnnoe)</option>
              <option value="--wgiven">use weights as given in MSA file (--wgiven)</option>
          </param>
          <when value="--wblosum">
              <param name="wid" label="Set identity cutoff" value="0.62"
                  type="float" help="(--wid)"/>
          </when>
      </conditional>
      <!-- Alternative effective sequence weighting strategies -->
      <conditional name="aeews">
          <param name="aeews_select" type="select" label="Alternative effective sequence weighting strategies">
              <option value="">Disabled</option>
              <option value="eent">Adjust eff seq # to achieve relative entropy target</option>
              <option value="eclust">Eff seq # is the # of single linkage clusters</option>
              <option value="enone">No effective seq # weighting: just use nseq</option>
          </param>
          <when value="eent">
              <param name="eset" type="float" value="0" label="set eff seq # for all models" help="(--eset)"/>
              <param name="ere" type="float" value="0" label="set minimum rel entropy/position" help="(--ere)"/>
              <param name="eent" type="float" value="45" label="set sigma param" help="(--esigma)" />
          </when>
          <when value="eclust">
              <param name="eset" type="float" value="0" label="set eff seq # for all models" help="(--eset)"/>
              <param name="edi" type="float" value="0.62" label="set fractional identity cutoff" min="0" max="1" help="(--eid)" />
          </when>
      </conditional>
      <param name="aps_select" type="select" label="Alternative Prior Strategies">
          <option value="" selected="true">Unspecified</option>
          <option value="--pnone">Don't use any prior; parameters are frequencies (--pnone)</option>
          <option value="--plaplace">Use a Laplace +1 prior (--plaplace)</option>
      </param>
      <!-- Handling single sequence inputs -->
      <conditional name="hssi">
          <param name="hssi_select" type="select" label="Options for handling single sequence inputs">
              <option value="false" selected="true">Disable</option>
              <option value="singlemx">Use substitution score matrix for single-sequence inputs</option>
          </param>
          <when value="singlemx">
              <param name="popen" type="float" value="0.1" label="gap open probability" help="(--popen)"/>
              <param name="pextend" type="float" value="0.1" label="gap extend probability" help="(--pextend)"/>
          </when>
          <!-- -mx <s>      : substitution score matrix (built-in matrices, with -singlemx)-->
          <!-- -mxfile <f>  : read substitution score matrix from file <f> (with -singlemx)-->
      </conditional>
      <!-- Control of E-value calibration -->
      <param name="EmL" type="integer" value="200" min="1" help="(--EmL)"
          label="Length of sequences for MSV Gumbel mu fit" />
      <param name="EmN" type="integer" value="200" min="1" help="(--EmN)"
          label="Number of sequences for MSV Gumbel mu fit" />

      <param name="EvL" type="integer" value="200" min="1" help="(--EvL)"
          label="Length of sequences for Viterbi Gumbel mu fit" />
      <param name="EvN" type="integer" value="200" min="1" help="(--EvN)"
          label="Number of sequences for Viterbi Gumbel mu fit" />

      <param name="EfL" type="integer" value="100" min="1" help="(--EfL)"
          label="Length of sequences for Forward exp tail tau fit" />
      <param name="EfN" type="integer" value="200" min="1" help="(--EfN)"
          label="Number of sequences for Forward exp tail tau fit" />

      <param name="Eft" type="float" value="0.04" min="0" max="1" help="(--Eft)"
          label="tail mass for Forward exponential tail tau fit" />
      <!-- Other Options -->
      <param name="seed" label="RNG seed, 0 generates a random seed" value="0" type="integer" help="(--seed)"/>
  </inputs>
  <outputs>
    <data format="hmm" name="hmmout" label="HMM profile from $msafile.name"/>
  </outputs>
  <tests>
      <test>
          <param name="msafile" value="globins4.sto" />
          <param name="seed" value="4" />
          <output name="hmmout" file="globins4.hmm" lines_diff="10" />
      </test>
  </tests>
  <help><![CDATA[
**What it does**

profile HMM construction from multiple sequence alignments

@ATTRIBUTION@
]]></help>
    <expand macro="citation" />
</tool>
