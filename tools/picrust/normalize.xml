<tool id="picrust_normalize" name="Normalize" version="@WRAPPER_VERSION@.0">
    <description>OTUs by copy number</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="aggressive"><![CDATA[
        normalize_by_copy_number.py
            -i '$input_data'
            -o tempout
            -c '$gg.precalc'

        #if $output_type == "json":
            && biom convert -i tempout -o '$out_file' --to-json
        #elif $output_type == "tsv":
            && biom convert -i tempout -o '$out_file' --to-tsv
        #else
            && biom convert -i tempout -o '$out_file' --to-hdf5
        #end if
    ]]></command>
      <inputs>
        <param name="input_data" type="data" format="tabular,biom1" label="Input file"/>
        <conditional name="gg">
           <param name="source" type="select" label="Select precalculated file from" help="">
               <option value="ref">Cached Reference</option>
               <option value="hist">History</option>
           </param>
           <when value="ref">
               <param name="precalc" type="select" label="Precalculated input marker gene copy number predictions on per-otu basis">
                   <options from_data_table="picrust_precalculated"/>
               </param>
           </when>
           <when value="hist">
               <param name="precalc" type="data" format="tabular" label="Precalculated input marker gene copy number predictions on per-otu basis"
                      help="files may be downloaded from PICRUSt website (see tool help below)" />
           </when>
       </conditional>
        <param name="output_type" type="select" label="Format of the output BIOM file">
            <option value="json" selected="true">JSON</option>
            <option value="hdf">HDF5</option>
            <option value="tsv">Classic (tab-separated text)</option>
        </param>
    </inputs>
    <outputs>
        <data name="out_file" format="tabular" label="${tool.name} on ${on_string}: Normalized OTUs"/>
    </outputs>
    <tests>
        <test> <!-- test with biom input -->
            <param name="input_data" value="closed_picked_otus.biom"/>
            <param name="input_type" value=" "/>
            <param name="source" value="hist"/>
            <param name="precalc" value="16S_13_5_precalculated_minimal.tab"/>
            <param name="output_type" value="json"/>
            <output name="out_file">
                <assert_contents>
                    <has_text text="Biological Observation Matrix"/>
                    <has_text text="generated_by"/>
                </assert_contents>
            </output>
        </test>
        <test> <!-- test with QIIME input and classic output -->
            <param name="input_data" value="closed_picked_otus.tab"/>
            <param name="source" value="hist"/>
            <param name="precalc" value="16S_13_5_precalculated_minimal.tab"/>
            <param name="output_type" value="tsv"/>
            <output name="out_file" file="normalized_otus.classic"/>
        </test>
    </tests>
    <help>
<![CDATA[
@PICRUST_OVERVIEW@

**Command Documenation**

This module corrects the abundance of each OTU to better reflect the true organism abundance by normalizing by PICRUSt's prediction of 16S copy number for each OTU.

Please ensure that you have properly created your OTU table to be compatible with PICRUSt by following this guide_.
A sample file can be downloaded here_

.. _guide: http://picrust.github.com/picrust/methods/constructing_reference_otus.html
.. _here: https://raw.github.com/picrust/picrust/master/tutorials/hmp_mock_16S.tab
]]>
    </help>
    <expand macro="citations"/>
</tool>
