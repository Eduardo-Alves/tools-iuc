<tool id="star_fusion" name="STAR-Fusion" version="0.5.4-0">
    <description>detect fusion genes in RNA-Seq data</description>
    <requirements>
        <requirement type="package" version="2.4.0d">rnastar</requirement>
        <requirement type="package" version="0.5.4">star_fusion</requirement>
        
        <!-- Bio-conda -->
        <requirement type="package" version="0.5.4">star-fusion</requirement>
    </requirements>
    
    <stdio>
        <regex match="Warning:" source="stderr" level="warning"/>
        <regex match="CMD:" source="stderr" level="warning"/>
        
        <regex match="-done creating index file:" source="stderr" level="warning"/>
        <regex match="-parsing GTF file:" source="stderr" level="warning"/>
        <regex match="-building interval tree" source="stderr" level="warning"/>
        <regex match="-parsing fusion evidence:" source="stderr" level="warning"/>
        <regex match="-mapping reads to genes" source="stderr" level="warning"/>
        <regex match="-outputting fusion candidates to file:" source="stderr" level="warning"/>
        
        <regex match="Process complete" source="stderr" level="warning"/>
    </stdio>
    
    <version_command>STAR-Fusion --version  2>&amp;1 | grep version | grep -o -E "software version.*?"</version_command>
    
    <command><![CDATA[
        ## 1. do blastn on the genome reference
        if file --mime-type "$refGenomeSource.blast_pairs" | grep -q /gzip\$; then
            gzip_suffix="" ;
        else
            gzip
                --fast
                --keep
                "$refGenomeSource.blast_pairs"
            &&
            
            gzip_suffix=".gz" ;
        fi ;
        
        ## 2. create reference index - using \$(pwd) is necessary, probably because the perl script changes work directory
        prep_genome_lib.pl
            --genome_fa "$refGenomeSource.ownFile"
            --gtf "$refGenomeSource.geneModel"
            --blast_pairs "$refGenomeSource.blast_pairs\$gzip_suffix"
            --CPU \${GALAXY_SLOTS:-1}
            --output_dir "\$(pwd)/tmp_star_fusion_genome_dir"
        &&
        
        ## 3. Run STAR-Fusion
        STAR-Fusion
            --chimeric_junction $chimeric_junction
        #if str($refGenomeSource.genomeSource) == 'history':
            --genome_lib_dir "\$(pwd)/tmp_star_fusion_genome_dir"
        #else
            --genome_lib_dir "$refGenomeSource.index.fields.path"
        #end if
        
        #if str($params.settingsType) == "full":
            --min_junction_reads $params.min_junction_reads
            --min_sum_frags $params.min_sum_frags
            --max_promiscuity $params.max_promiscuity
            --min_novel_junction_support $params.min_novel_junction_support
            --min_alt_pct_junction $params.min_alt_pct_junction
            --aggregate_novel_junction_dist $params.aggregate_novel_junction_dist
            --E $params.E
        #end if
    ]]></command>

    <inputs>
        <param name="chimeric_junction" type="data" format="interval" label="Chimeric junction file from STAR (with STAR-Fusion settings)" />
        
        <!-- Genome source. -->
        <conditional name="refGenomeSource">
            <param name="genomeSource" type="select" label="Custom or built-in reference genome" help="Built-ins were indexed using default options">
                <option value="indexed" selected="True">Use a built-in index</option>
                <option value="history">Index and use a genome fasta and GTF file from history</option>
            </param>
            <when value="indexed">
            <param name="index" type="select" label="Select a reference genome">
                <options from_data_table="rnastar_index">
                    <filter type="sort_by" column="2"/>
                    <validator type="no_options" message="No indexes are available for the selected input dataset"/>
                </options>
            </param>
            </when>
            <when value="history">
                <param name="ownFile" type="data" format="fasta" metadata_name="dbkey" label="Select the reference genome" />
                <param name="geneModel" type="data" format="gff3,gtf" label="Gene model (gff3,gtf) file for splice junctions and fusion gene detection" />
                <param name="blast_pairs" type="data" format="tabular" label="Result of BLAST+-blastn of the reference fasta sequence with itself" help="Run blastn with '-outputfmt 6' or choose 'Tabular (standard 12 columns)' in the Galaxy wrapper" />
            </when>
        </conditional>
        
        <conditional name="params">
            <param name="settingsType" type="select" label="Settings to use" help="You can use the default settings or set custom values for any STAR Fusion parameter.">
                <option value="default" selected="true">Use Defaults</option>
                <option value="full">Full parameter list</option>
            </param>
            <when value="default" />
            <when value="full"><!-- Full/advanced params. -->
                <param name="min_junction_reads" type="integer" value="1" label="minimum number of junction-spanning reads required." help="(--min_junction_reads)" />
                <param name="min_sum_frags" type="integer" value="2" label="minimum fusion support = (#junction_reads + #spanning_frags)" help="(--min_sum_frags)" />
                <param name="max_promiscuity" type="integer" value="3" label="maximum number of partners allowed for a given fusion" help="(--max_promiscuity)" />
                <param name="min_novel_junction_support" type="integer" value="3" label="minimum of 3 junction reads required if breakpoint lacks involvement of only reference junctions" help="(--min_novel_junction_support)" />
                <param name="min_alt_pct_junction" type="float" value="10" label="10% of the dominant isoform junction support" help="(--min_alt_pct_junction)" />
                <param name="aggregate_novel_junction_dist" type="integer" value="5" label="non-ref junctions within 5 are merged into single calls" help="(--aggregate_novel_junction_dist)" />
                <param name="E" type="float" value="0.001" label="E-value threshold for blast searches" help="(-E)" />
            </when>
        </conditional>
    </inputs>

    <outputs>
        <data format="tabular" name="output_final" label=".fusion_candidates.final" from_work_dir="star-fusion.fusion_candidates.final"/>
    </outputs>

    <tests>
        <test>
            <param name="chimeric_junction" ftype="interval" value="test1.tabular" />
            <param name="genomeSource" value="history" />
            <param name="ownFile" ftype="fasta" value="test1.fa" />
            <param name="geneModel" ftype="gtf" value="test1.gtf" />
            <param name="blast_pairs" ftype="tabular" value="test1-test1.blastn.tabular" />
            <param name="settingsType" value="default" />
            
            <!-- Last column of the results contains data in a random order so exact matching is not feasible -->
            <output name="output_final">
                <assert_contents>
                    <has_line line="#fusion_name&#009;JunctionReads&#009;SpanningFrags&#009;Splice_type&#009;LeftGene&#009;LeftBreakpoint&#009;RightGene&#009;RightBreakpoint&#009;JunctionReads&#009;SpanningFrags" />
                    <has_text text="GENE1--GENE2&#009;24&#009;0&#009;INCL_NON_REF_SPLICE&#009;GENE1^GENE1&#009;chr1:240:+&#009;GENE2^GENE2&#009;chr2:241:+" />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help>
        **What it does**
    </help>

    <citations>
        <citation type="bibtex">
           @unpublished{star_fusion,
              author = {Brian Haas and Nicolas Stransky and Daniel Nicorici}, 
              title  = {STAR-Fusion},
              url    = {https://github.com/STAR-Fusion/STAR-Fusion}
            }
        </citation>
    </citations>
</tool>
