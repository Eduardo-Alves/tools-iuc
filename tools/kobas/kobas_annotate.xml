<tool id="kobas_annotate" name="KOBAS Annotate" version="0.1">
    <description>KEGG Orthology Based Annotation System</description>
    <requirements>
        <requirement type="package" version="2.5.0">blast</requirement>
        <requirement type="package" version="2.1.1">kobas</requirement>
    </requirements>
    <stdio>
        <exit_code range="0" level="warning" description="BiopythonDeprecationWarning"/>
        <exit_code range="1" level="fatal" description="Bad input settings or none of the entries was annotated successfully."/>
    </stdio>
    <command>
        <![CDATA[

        ## create the database symlinks to comply with how KOBAS wants them
		ln -s $organismdb organism.db &&
		ln -s $kobasdb ${species}.db &&
		ln -s ${os.path.join($blastdb.extra_files_path,'blastdb')}.phr ${species}.pep.fasta.phr &&
		ln -s ${os.path.join($blastdb.extra_files_path,'blastdb')}.pin ${species}.pep.fasta.pin &&
		ln -s ${os.path.join($blastdb.extra_files_path,'blastdb')}.psq ${species}.pep.fasta.psq &&

        ## create the orthologe database symlinks to comply with how KOBAS wants them
        #if $ortholog.only == 'YES' and str($ortholog.species) != str($species):
            ln -s $ortholog.kobasdb ${ortholog.species}.db &&
            ln -s ${os.path.join($ortholog.blastdb.extra_files_path,'blastdb')}.phr ${ortholog.species}.pep.fasta.phr &&
		    ln -s ${os.path.join($ortholog.blastdb.extra_files_path,'blastdb')}.pin ${ortholog.species}.pep.fasta.pin &&
		    ln -s ${os.path.join($ortholog.blastdb.extra_files_path,'blastdb')}.psq ${ortholog.species}.pep.fasta.psq &&
        #end if

        kobas-annotate
			-i $input
			-t $intype
			-s $species
			-e $evalue
			-r $rank
			-c $coverage
            #if $ortholog.only == 'YES':
                -z $ortholog.species
            #end if
			-y ./
			-q ./
			-p blastp
			-x blastx
			-o $output

        ]]>
    </command>
    <inputs>
        <param format="fasta" name="input" type="data" label="Input file" help="Input data file matching the input type."/>
        <param name="intype" type="select" label="Input type">
            <option value="fasta:pro">FASTA protein sequence</option>
            <option value="fasta:nuc">FASTA nucleotide sequence</option>
            <option value="blastout:xml">XML BLAST output</option>
            <option value="blastout:tab">Tabular BLAST output</option>
            <option value="id:uniprot">UniProtKB AC</option>
            <option value="id:ensembl">Ensembl Gene ID</option>
            <option value="id:ncbigene">Entrez Gene ID</option>
            <option value="id:refseqpro">Refseq Protein ID</option>
        </param>
        <param name="blastdb" type="data" format="blastdbp" label="Protein BLAST database"/>
        <param
            name="species"
            size="3"
            type="text"
            label="Species abbreviation"
            help="For example: ko for KEGG Orthology, hsa for Homo sapiens, mmu for Mus musculus, dme for Drosophila melanogaster, ath for Arabidopsis thaliana, sce for Saccharomyces cerevisiae and eco for Escherichia coli K-12 MG1655."/>

        <param format="sqlite" name="kobasdb" type="data" label="Kobas database" help="kobas species database"/>
        <param format="sqlite" name="organismdb" type="data" label="Organism database" help="kobas organism database"/>
        <param name="evalue" size="3" type="text" value="1e-5" label="expect threshold for BLAST, default 1e-5"/>
        <param name="rank" size="2" type="integer" value="5" label="rank cutoff for valid hits from BLAST result, default 5"/>
        <param name="coverage" size="2" type="integer" value="0" label="subject coverage cutoff for BLAST, default 0"/>
        <conditional name="ortholog">
            <param name="only" type="select" label="Only use orthologs" help="Whether only use orthologs for cross-species annotation or not, default NO (if only use orthologs, please provide the species abbreviation of your input)">
                <option value="NO">No</option>
                <option value="YES">Yes</option>
            </param>
            <when value="YES">
                <param
                    name="species"
                    size="3"
                    type="text"
                    label="Ortholog species abbreviation"
                    help="For example: ko for KEGG Orthology, hsa for Homo sapiens, mmu for Mus musculus, dme for Drosophila melanogaster, ath for Arabidopsis thaliana, sce for Saccharomyces cerevisiae and eco for Escherichia coli K-12 MG1655."/>
                <param name="kobasdb" format="sqlite" type="data" label="Ortholog KOBAS database" help="KOBAS species database"/>
                <param name="blastdb" type="data" format="blastdbp" label="Ortholog protein BLAST database"/>
            </when>
            <when value="NO"></when>
        </conditional>
    </inputs>
    <outputs>
        <data format="tabular" name="output"/>
    </outputs>

    <tests>
        <test>
            <param name="input" value="kobas_annotate_input.fasta"/>
            <param name="intype" value="fasta:pro"/>
            <param name="species" value="aaa"/>
            <param name="kobasdb" value="aaa.db"/>
            <param name="organismdb" value="organism.db"/>
            <output name="out_file1" file="kobas_annotate_output.txt"/>
        </test>
    </tests>

    <help>
        **KOBAS**

        KOBAS is a KEGG Orthology Based Annotation System. Its purpose is to identify statistically enriched pathways, diseases, and GO terms for a set of genes or proteins, using pathway, disease, and GO knowledge from multiple famous databases.

        **KOBAS Annotate**

        Annotates an input set of genes with putative pathways and disease relationships based on mapping to genes with known annotations. It allows for both ID mapping and cross-species sequence similarity mapping.

        KOBAS can be accessed at http://kobas.cbi.pku.edu.cn.
    </help>

    <citations>
        <citation type="doi">10.1093/nar/gkr483</citation>
    </citations>

</tool>
