<tool id="jbrowse" name="JBrowse" version="0.3">
  <description>genome browser</description>
  <macros>
    <import>macros.xml</import>
  </macros>
  <expand macro="requirements"/>
  <expand macro="stdio"/>
  <version_command>python jbrowse.py --version</version_command>
  <command interpreter="python"><![CDATA[jbrowse.py
$trackYaml
#for $genome in $genomes:
 $genome
#end for

--jbrowse \${JBROWSE_SOURCE_DIR}
--outdir $output.files_path
> $output]]></command>
  <configfiles>
      <configfile name="trackYaml">
---
#for $track in $data_tracks:
  -
    files:
     #for $dataset in $track.data_format.annotation:
      - ${dataset}
     #end for
    ext:
     #for $dataset in $track.data_format.annotation:
      - ${dataset.ext}
     #end for
    labels:
     #for $dataset in $track.data_format.annotation:
      - ${dataset.element_identifier}
     #end for
    category: "${track.category}"
    format: "${track.data_format.data_format_select}"
    options:
        style:
            className: "${track.data_format.jbstyle.style_classname}"
            description: "${track.data_format.jbstyle.style_description}"
            label: "${track.data_format.jbstyle.style_label}"
            height: "${track.data_format.jbstyle.style_height}"
        #if str($track.data_format.data_format_select) == "wiggle":
          ## Wiggle tracks need special colour config
            color_config: "${track.data_format.jbcolor.color.color_select}"
          #if str($track.data_format.jbcolor.color.color_select) == "brewer":
            color: "${track.data_format.jbcolor.color.brewer_scheme}"
          #else:
            color_pos: "${track.data_format.jbcolor.color.style_pos_color}"
            color_neg: "${track.data_format.jbcolor.color.style_neg_color}"
          #end if
          ## Bicolor pivot config
          #if str($track.data_format.jbcolor.bicolor_pivot.bicolor_pivot_select) == "zero":
            bicolor_pivot: "zero"
          #else if str($track.data_format.jbcolor.bicolor_pivot.bicolor_pivot_select) == "mean":
            bicolor_pivot: "mean"
          #else:
            bicolor_pivot: "${track.data_format.jbcolor.bicolor_pivot.pivot_point}"
          #end if
        #else if str($track.data_format.data_format_select) == "gene_calls" or  str($track.data_format.data_format_select) == "blast":
            ## auto_color
            #if str($track.data_format.jbcolor.color.color_select) == "automatic":
            color: "__auto__"
            #else
            color: "${track.data_format.jbcolor.color.style_color}"
            #end if
            ## scaling
            #if str($track.data_format.jbcolor_scale.color_score) == "none":
            score:
              method: "ignore"
              #if str($track.data_format.jbcolor_scale.color.color_select) == "automatic":
              color: "__auto__"
              #else
              color: "${track.data_format.jbcolor_scale.color.style_color}"
              #end if
            #else
            score:
              method: "score"
              algo: "${track.data_format.jbcolor_scale.score_scaling}"
              scales:
                type: "${track.data_format.jbcolor_scale.score_scales.scale_select}"
                #if str($track.data_format.jbcolor_scale.score_scales.scale_select) == "manual":
                min: "${track.data_format.jbcolor_scale.score_scales.minimum}"
                max: "${track.data_format.jbcolor_scale.score_scales.maximum}"
                #end if
              scheme:
                type: "${track.data_format.jbcolor_scale.color_scheme.score_scheme}"
                ## auto_color
                #if str(track.data_format.jbcolor_scale.color_scheme.score_scheme) == "opacity":
                  #if str($track.data_format.jbcolor_scale.color_scheme.color.color_select) == "automatic":
                color: "__auto__"
                  #else
                color: "${track.data_format.jbcolor_scale.color_scheme.color.style_color}"
                  #end if
                #else
                brewer: "${track.data_format.jbcolor_scale.color_scheme.brewer_scheme}"
                #end if
            #end if
        #else:
          #if str($track.data_format.jbcolor.color.color_select) == "automatic":
            color: "__auto__"
          #else:
            color: "${track.data_format.jbcolor.color.style_color}"
          #end if
        #end if
    #if str($track.data_format.data_format_select) == "wiggle":
        type: ${track.data_format.xyplot}
        variance_band: ${track.data_format.var_band}
      #if str($track.data_format.scaling.scale_select) == "auto_local":
        autoscale: local
      #else if str($track.data_format.scaling.scale_select) == "auto_global":
        autoscale: global
      #else:
        min: ${track.data_format.scaling.minimum}
        max: ${track.data_format.scaling.maximum}
      #end if
    #else if str($track.data_format.data_format_select) == "pileup":
        auto_snp: ${track.data_format.auto_snp}
        bam_indexes:
         #for $dataset in $track.data_format.annotation:
          - ${dataset.metadata.bam_index}
         #end for
    #else if str($track.data_format.data_format_select) == "blast":
        parent: ${track.data_format.blast_parent}
        protein: ${track.data_format.is_protein}
        min_gap: ${track.data_format.min_gap}
        match: true
    #else if str($track.data_format.data_format_select) == "gene_calls":
        match: ${track.data_format.match_part}
    #end if
#end for
      </configfile>
  </configfiles>
  <inputs>
    <param label="Fasta Sequence(s)"
           name="genomes"
           type="data"
           format="fasta"
           multiple="True"/>
    <repeat name="data_tracks" title="Annotation Track">
        <param label="Track Category"
               name="category"
               type="text"
               value="Default"
               help="Organise your tracks into Categories for a nicer end-user experience"/>
        <conditional name="data_format" label="Track Options">
            <param type="select" label="Track Type" name="data_format_select">
                <option value="gene_calls">GFF/GFF3/BED/GBK Featuers</option>
                <option value="pileup">BAM Pileups</option>
                <option value="blast">Blast XML</option>
                <option value="wiggle">BigWig XY</option>
                <option value="vcf">VCF SNPs</option>
            </param>
            <when value="blast">
                <expand macro="input_conditional" label="BlastXML Track Data" format="blastxml" />

                <param label="Features used in Blast Search"
                       help="in GFF3. This is required so we know where to map features. E.g. where results of which CDS Protein32 match up to. The query IDs in your blast results should MATCH some feature IDs in your GFF3 file."
                       format="gff3"
                       name="blast_parent"
                       type="data"/>

                <param label="Minimum Gap Size"
                       help="before a new match_part feature is created"
                       name="min_gap"
                       type="integer"
                       value="10"
                       min="2" />
                <param label="Is this a protein blast search?"
                       type="boolean"
                       name="is_protein"
                       truevalue="true"
                       falsevalue="false" />

                <expand macro="track_styling"
                        classname="feature"
                        label="description"
                        description="Hit_titles"
                        height="600px"/>
                <expand macro="colour_selection"
                        token_scaling_lin_select="false"
                        token_scaling_log_select="true" />
            </when>
            <when value="vcf">
                <expand macro="input_conditional" label="SNP Track Data" format="vcf" />
                <expand macro="track_styling" />
            </when>
            <when value="gene_calls">
                <expand macro="input_conditional" label="GFF/GFF3/BED Track Data" format="gff,gff3,bed" />
                <param label="This is match/match_part data"
                       type="boolean"
                       name="match_part"
                       truevalue="true"
                       falsevalue="false" />
                <expand macro="track_styling" />
                <expand macro="colour_selection" />
            </when>
            <when value="pileup">
                <expand macro="input_conditional" label="BAM Track Data" format="bam" />
                <param label="Autogenerate SNP Track"
                       help="Not recommended for deep coverage BAM files"
                       type="boolean"
                       name="auto_snp"
                       truevalue="true"
                       falsevalue="false" />
                <expand macro="track_styling" />
            </when>
            <when value="wiggle">
                <expand macro="input_conditional" label="BigWig Track Data" format="bigwig" />

                <param label="Use XYPlot"
                       help="instead of continuous coloured band"
                       type="boolean"
                       name="xyplot"
                       truevalue="JBrowse/View/Track/Wiggle/XYPlot"
                       falsevalue="JBrowse/View/Track/Wiggle/Density" />
                <param label="Show variance band"
                       help="Only for XYPlots"
                       type="boolean"
                       name="var_band"
                       truevalue="true"
                       falsevalue="false" />

                <conditional name="scaling" label="Scaling">
                    <param type="select" label="Track Scaling" name="scale_select">
                        <option value="auto_local">Autoscale (local)</option>
                        <option value="auto_global">Autoscale (global)</option>
                        <option value="fixed">Specify Min/Max</option>
                    </param>
                    <when value="auto_local"></when>
                    <when value="auto_global"></when>
                    <when value="fixed">
                        <param label="Track minimum" name="minimum"
                            type="integer" value="0" />
                        <param label="Track maximum" name="maximum"
                            type="integer" value="100" />
                    </when>
                </conditional>
                <expand macro="track_styling" />
                <expand macro="colour_selection_minmax" />
            </when>
        </conditional>
    </repeat>
  </inputs>
  <outputs>
      <data format="html" name="output" label="JBrowse on $genomes"/>
  </outputs>
  <help><![CDATA[
Build a static JBrowse visualization of a genome and some associated datasets.

@ATTRIBUTION@
]]></help>
  <tests>
    <test>
      <param name="genomes" value="merlin.fa"/>
      <output name="output" file="out-0/output.html" >
        <extra_files type="file" name="output/JBrowse-1.11.6/data/seq/refSeqs.json" value="peakcalling_macs/test2/Galaxy_Test_Run_model.pdf" compare="re_match"/>
      </output>
    </test>
  </tests>
  <citations>
    <citation type="doi">10.1101/gr.094607.109</citation>
  </citations>
</tool>

